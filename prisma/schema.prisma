// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// ============================================
// User & Authentication
// ============================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  profileId String?
  profile   Profile? @relation(fields: [profileId], references: [id], onDelete: SetNull)
  avatar    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices   Invoice[]
  quotations Quotation[]

  @@map("users")
}

model Profile {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  permissions ProfilePermission[]

  @@map("profiles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  module      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  profiles ProfilePermission[]

  @@map("permissions")
}

model ProfilePermission {
  id           String     @id @default(cuid())
  profileId    String
  profile      Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([profileId, permissionId])
  @@map("profile_permissions")
}

// ============================================
// Customer
// ============================================
model Customer {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  taxId        String?
  email        String?
  phone        String?
  fax          String?
  customerFrom String?  // ลูกค้าจาก
  socialId     String?  // Social ID รองรับ emoji
  address      String?  @db.Text
  source       String?  // ที่มา: google, facebook, line, website, tiktok
  contactName  String?
  contactPhone String?
  notes        String?  @db.Text
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  invoices   Invoice[]
  quotations Quotation[]

  @@map("customers")
}

// ============================================
// Sale (พนักงานขาย)
// ============================================
model Sale {
  id        Int      @id @default(autoincrement())
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sales")
}

// ============================================
// Wholesale (โฮลเซลล์/ซัพพลายเออร์)
// ============================================
model Wholesale {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  nameTh    String   // ชื่อภาษาไทย
  nameEn    String?  // ชื่อภาษาอังกฤษ
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("wholesales")
}

// ============================================
// Airline (สายการบิน)
// ============================================
model Airline {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("airlines")
}

// ============================================
// Country (ประเทศ)
// ============================================
model Country {
  id        Int      @id @default(autoincrement())
  code      String   @unique // ISO2 code (TH, JP, etc.)
  nameTh    String   // ชื่อภาษาไทย
  nameEn    String   // ชื่อภาษาอังกฤษ
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("countries")
}

// ============================================
// Quotation (ใบเสนอราคา)
// ============================================
model Quotation {
  id                Int             @id @default(autoincrement())
  quotationNumber   String          @unique // QT2601xxxx (รันเลข)

  // ข้อมูลลูกค้า
  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id])

  // ข้อมูลทัวร์
  tourName          String          // ชื่อแพ็คเกจทัวร์
  bookingCode       String?         // รหัสจอง Auto (BK + YY + MM + 0001)
  ntCode            String?         // รหัส NextTrip (NT + YY + MM + 0001)
  customTourCode    String?         // รหัสทัวร์กำหนดเอง
  countryId         Int?            // ID จาก DB2 (tb_country) - ไม่มี FK
  airlineId         Int?            // ID จาก DB2 (tb_travel_type) - ไม่มี FK
  wholesaleId       Int?            // ID จาก DB2 (tb_wholesale) - ไม่มี FK

  // วันที่เดินทาง
  departureDate     DateTime?       // วันเดินทางไป
  returnDate        DateTime?       // วันเดินทางกลับ
  numDays           String?         // จำนวนวัน เช่น "5D4N"
  paxCount          Int             @default(0) // จำนวนผู้เดินทาง

  // พนักงานขาย
  saleId            Int?            // ID จาก DB2 (users) - ไม่มี FK

  // วันที่เอกสาร
  quotationDate     DateTime        @default(now()) // วันที่ออกใบเสนอราคา
  validUntil        DateTime?       // ใช้ได้ถึงวันที่

  // การชำระเงิน - มัดจำ
  depositDueDate    DateTime?       // กำหนดชำระมัดจำ
  depositAmount     Decimal         @default(0) @db.Decimal(12, 2) // จำนวนเงินมัดจำ

  // การชำระเงิน - เต็มจำนวน
  fullPaymentDueDate DateTime?      // กำหนดชำระเต็มจำนวน
  fullPaymentAmount  Decimal        @default(0) @db.Decimal(12, 2) // จำนวนเงินที่ต้องชำระเต็ม

  // การคำนวณ VAT
  vatMode           String          @default("EXCLUDE") // INCLUDE หรือ EXCLUDE

  // ยอดรวม
  subtotal          Decimal         @default(0) @db.Decimal(12, 2) // ยอดรวมก่อนส่วนลด/ภาษี
  discountAmount    Decimal         @default(0) @db.Decimal(12, 2) // ส่วนลด
  vatExemptAmount   Decimal         @default(0) @db.Decimal(12, 2) // ยอดยกเว้นภาษี
  preTaxAmount      Decimal         @default(0) @db.Decimal(12, 2) // ราคาสุทธิสินค้าที่เสียภาษี
  preVatAmount      Decimal         @default(0) @db.Decimal(12, 2) // ราคาก่อนภาษีมูลค่าเพิ่ม (หลังหักส่วนลด)
  vatAmount         Decimal         @default(0) @db.Decimal(12, 2) // ภาษีมูลค่าเพิ่ม 7%
  includeVatAmount  Decimal         @default(0) @db.Decimal(12, 2) // ราคารวมภาษีมูลค่าเพิ่ม
  grandTotal        Decimal         @default(0) @db.Decimal(12, 2) // จำนวนเงินรวมทั้งสิ้น

  // หัก ณ ที่จ่าย
  withholdingTax    Decimal         @default(0) @db.Decimal(12, 2) // หัก ณ ที่จ่าย 3%
  hasWithholdingTax Boolean         @default(false) // มีการหัก ณ ที่จ่าย
  netPayable        Decimal         @default(0) @db.Decimal(12, 2) // ยอดสุทธิที่ต้องชำระ (หลังหักภาษี ณ ที่จ่าย)

  // ByPass ไม่มีต้นทุน
  noCost            Boolean         @default(false) // ไม่มีต้นทุน (ByPass)

  // ค่าคอมมิชชั่น
  commission        Decimal         @default(0) @db.Decimal(12, 2)
  commissionNote    String?

  // สถานะ
  status            QuotationStatus @default(NEW)
  paymentStatus     PaymentStatus   @default(UNPAID)

  // หมายเหตุ
  notes             String?         @db.Text
  cancelNote        String?         @db.Text

  // ผู้สร้าง/แก้ไข
  createdById       String
  createdBy         User            @relation(fields: [createdById], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  items    QuotationItem[]
  invoices Invoice[]

  @@map("quotations")
}

enum QuotationStatus {
  NEW      // ร่าง
  PENDING    // รอดำเนินการ
  CONFIRMED  // ยืนยันแล้ว
  CANCELLED  // ยกเลิก
  COMPLETED  // เสร็จสิ้น
}

enum PaymentStatus {
  UNPAID     // ยังไม่ชำระ
  DEPOSIT    // ชำระมัดจำแล้ว
  PARTIAL    // ชำระบางส่วน
  PAID       // ชำระครบแล้ว
  REFUNDED   // คืนเงินแล้ว
}

model QuotationItem {
  id          Int         @id @default(autoincrement())
  quotationId Int
  quotation   Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  // สินค้า/บริการ
  productId   Int?
  product     Product?    @relation(fields: [productId], references: [id])
  productName String      // ชื่อสินค้า (snapshot ณ เวลาสร้าง)

  // รายละเอียด
  quantity    Int         @default(1) // จำนวน
  unitPrice   Decimal     @db.Decimal(12, 2) // ราคาต่อหน่วย
  amount      Decimal     @db.Decimal(12, 2) // ยอดรวม

  // ประเภท
  itemType    ItemType    @default(INCOME) // รายได้/ส่วนลด/ฟรี

  // VAT
  vatType     VatType     @default(NO_VAT) // ประเภท VAT
  hasWithholdingTax Boolean @default(false) // มีหัก ณ ที่จ่าย

  sortOrder   Int         @default(0) // ลำดับการแสดง

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("quotation_items")
}

enum ItemType {
  INCOME    // รายได้
  DISCOUNT  // ส่วนลด
  FREE      // ฟรี
}

enum VatType {
  NO_VAT    // ไม่มี VAT
  VAT       // มี VAT
  VAT_EXEMPT // ยกเว้น VAT
}

// ============================================
// Invoice (ใบแจ้งหนี้)
// ============================================
model Invoice {
  id            Int           @id @default(autoincrement())
  invoiceNumber String        @unique
  quotationId   Int?
  quotation     Quotation?    @relation(fields: [quotationId], references: [id])
  customerId    String
  customer      Customer      @relation(fields: [customerId], references: [id])
  createdById   String
  createdBy     User          @relation(fields: [createdById], references: [id])
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(12, 2)
  discountPercent Decimal     @default(0) @db.Decimal(5, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(12, 2)
  taxPercent    Decimal       @default(7) @db.Decimal(5, 2)
  taxAmount     Decimal       @db.Decimal(12, 2)
  total         Decimal       @db.Decimal(12, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(12, 2)
  status        InvoiceStatus @default(NEW)
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items    InvoiceItem[]
  payments Payment[]
  receipts Receipt[]

  @@map("invoices")
}

enum InvoiceStatus {
  NEW
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId   Int?
  product     Product? @relation(fields: [productId], references: [id])
  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2)
  amount      Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("invoice_items")
}

// ============================================
// Payment (การรับชำระเงิน)
// ============================================
model Payment {
  id            Int           @id @default(autoincrement())
  paymentNumber String        @unique
  invoiceId     Int
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
  amount        Decimal       @db.Decimal(12, 2)
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod
  reference     String?
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  receipt Receipt?

  @@map("payments")
}

enum PaymentMethod {
  CASH
  TRANSFER
  CREDIT_CARD
  CHEQUE
  OTHER
}

// ============================================
// Receipt (ใบเสร็จรับเงิน)
// ============================================
model Receipt {
  id            Int      @id @default(autoincrement())
  receiptNumber String   @unique
  invoiceId     Int
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])
  paymentId     Int      @unique
  payment       Payment  @relation(fields: [paymentId], references: [id])
  issueDate     DateTime @default(now())
  amount        Decimal  @db.Decimal(12, 2)
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("receipts")
}

// ============================================
// Company Settings
// ============================================
model CompanySetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

// ============================================
// Running Number
// ============================================
model RunningNumber {
  id        String   @id @default(cuid())
  type      String   @unique // INVOICE, QUOTATION, PAYMENT, RECEIPT
  prefix    String
  year      Int
  lastNumber Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("running_numbers")
}

// ============================================
// Product (รายการสินค้า/บริการ)
// ============================================
model Product {
  id              Int                @id @default(autoincrement())
  name            String             // ชื่อรายการสินค้า/บริการ
  calculationType CalculationType    @default(INCOME) // ประเภทการคำนวณ
  includePax      Boolean            @default(false) // ตัวเลือกนี้รวมผล PAX
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  quotationItems  QuotationItem[]
  invoiceItems    InvoiceItem[]

  @@map("products")
}

enum CalculationType {
  INCOME    // รายได้
  DISCOUNT  // ส่วนลด
  FREE      // ฟรี
}
